---
alwaysApply: false
---

# 뉴스 상태 흐름 다이어그램 (API 포함)

## 📋 개요

뉴스는 콘텐츠 관리 시스템의 핵심 엔티티로, **상태(Status)**와 **공개 여부(isPublic)** 두 가지 차원에서 관리됩니다.
언론 보도 및 뉴스 기사를 관리하며, 다국어를 지원하지 않고 단일 언어(한국어)로만 작성됩니다.

## 🔄 상태(Status) 정의

| 상태       | 값             | 설명                              |
| ---------- | -------------- | --------------------------------- |
| **초안**   | `draft`        | 작성 중인 상태, 아직 검토 요청 전 |
| **검토중** | `under_review` | 검토 요청 후 승인 대기 중         |
| **승인됨** | `approved`     | 검토 완료, 승인된 상태            |
| **거부됨** | `rejected`     | 검토 결과 거부된 상태             |
| **공개됨** | `opened`       | 최종 공개된 상태                  |

## 📊 상태 전이 다이어그램 (API 포함)

```mermaid
stateDiagram-v2
    [*] --> draft: 뉴스 생성

    draft --> under_review: 검토 요청 (구현 필요)
    draft --> draft: 수정/삭제 가능

    under_review --> approved: 승인 (구현 필요)
    under_review --> rejected: 거부 (구현 필요)
    under_review --> draft: 검토 취소 (구현 필요)

    approved --> opened: 공개 설정 (구현 필요)
    approved --> draft: 수정 시작 (구현 필요)

    rejected --> draft: 수정 시작 (구현 필요)

    opened --> draft: 수정 시작
    opened --> opened: 비공개 설정

    note right of draft
        초안 상태
        모든 수정 가능
    end note

    note right of under_review
        검토중 상태
        수정/삭제 불가
    end note

    note right of approved
        승인됨 상태
        공개 준비 완료
    end note

    note right of rejected
        거부됨 상태
        수정 필요
    end note

    note right of opened
        공개됨 상태
        사용자 노출
    end note
```

### 🔗 상태 전이와 API 매핑

| 상태 전이               | 액션        | API 엔드포인트                                                                                                     | 구현 상태 |
| ----------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------ | --------- |
| **[생성]** → draft      | 뉴스 생성   | `POST /api/admin/news`                                                                                             | ✅        |
| draft → under_review    | 검토 요청   | `PATCH /api/admin/news/:id/status` (구현 필요)                                                                     | ❌        |
| draft → draft           | 수정/삭제   | `PUT /api/admin/news/:id`<br/>`PATCH /api/admin/news/:id/public`<br/>`PUT /api/admin/news/batch-order`<br/>`DELETE /api/admin/news/:id` | ✅        |
| under_review → approved | 승인        | `PATCH /api/admin/news/:id/status` (구현 필요)                                                                     | ❌        |
| under_review → rejected | 거부        | `PATCH /api/admin/news/:id/status` (구현 필요)                                                                     | ❌        |
| under_review → draft    | 검토 취소   | `PATCH /api/admin/news/:id/status` (구현 필요)                                                                     | ❌        |
| approved → opened       | 공개 설정   | `PATCH /api/admin/news/:id/status` (구현 필요)                                                                     | ❌        |
| approved → draft        | 수정 시작   | `PUT /api/admin/news/:id` (자동 상태 전이, 구현 필요)                                                              | ❌        |
| rejected → draft        | 수정 시작   | `PATCH /api/admin/news/:id/status` (구현 필요)                                                                     | ❌        |
| opened → draft          | 수정 시작   | `PUT /api/admin/news/:id` (자동 상태 전이, 구현 필요)                                                              | ❌        |
| opened → opened         | 비공개 설정 | `PATCH /api/admin/news/:id/public`                                                                                 | ✅        |

## 🌐 전체 API 엔드포인트 맵

### 상태와 무관한 조회 API

```mermaid
graph LR
    A[뉴스 API] --> B[GET /news]
    A --> C[GET /news/all]
    A --> D[GET /news/:id]
    A --> E[GET /news/categories]

    B --> B1[목록 조회 페이징]
    C --> C1[전체 목록]
    D --> D1[상세 조회]
    E --> E1[카테고리 목록]
```

### 상태별 가능한 API 액션

```mermaid
graph TD
    subgraph DRAFT["DRAFT 초안"]
        D1[POST 생성 ✅]
        D2[PUT 수정 ✅]
        D3[PATCH public ✅]
        D4[PUT batch-order ✅]
        D5[DELETE 삭제 ✅]
        D6[PATCH status → UNDER_REVIEW ❌]
    end

    subgraph UNDER_REVIEW["UNDER_REVIEW 검토중 구현 필요"]
        U1[GET 조회만 가능]
        U2[PATCH status → APPROVED ❌]
        U3[PATCH status → REJECTED ❌]
        U4[PATCH status → DRAFT ❌]
    end

    subgraph APPROVED["APPROVED 승인됨 구현 필요"]
        A1[GET 조회]
        A2[PATCH status → OPENED ❌]
        A3[PATCH public ✅]
        A4[PUT 수정 → DRAFT 전이 ❌]
        A5[DELETE 삭제 ✅]
    end

    subgraph REJECTED["REJECTED 거부됨 구현 필요"]
        R1[GET 조회]
        R2[PATCH status → DRAFT ❌]
        R3[DELETE 삭제 ✅]
    end

    subgraph OPENED["OPENED 공개됨"]
        O1[GET 조회]
        O2[PATCH public ✅]
        O3[PUT 수정 → DRAFT 전이 ❌]
        O4[DELETE 삭제 ✅]
    end

    style DRAFT fill:#e3f2fd
    style UNDER_REVIEW fill:#fff3e0
    style APPROVED fill:#e8f5e9
    style REJECTED fill:#ffebee
    style OPENED fill:#f3e5f5
```

## 🔄 상태 전이 시퀀스 다이어그램

### 시나리오 1: 정상적인 공개 프로세스

```mermaid
sequenceDiagram
    participant Admin as 관리자
    participant API as API 서버
    participant DB as 데이터베이스

    Note over Admin,DB: 1. 뉴스 생성
    Admin->>API: POST /api/admin/news
    API->>DB: INSERT (status: 'draft', isPublic: false)
    DB-->>API: 생성 완료
    API-->>Admin: 201 Created (DRAFT)

    Note over Admin,DB: 2. 내용 및 파일 수정
    Admin->>API: PUT /api/admin/news/:id
    API->>DB: UPDATE title, description, url, files
    DB-->>API: 수정 완료
    API-->>Admin: 200 OK

    Note over Admin,DB: 3. 검토 요청 (구현 필요)
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: {status: 'under_review'}
    API->>DB: UPDATE status = 'under_review'
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (UNDER_REVIEW)

    Note over Admin,DB: 4. 승인 (구현 필요)
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: {status: 'approved'}
    API->>DB: UPDATE status = 'approved'
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (APPROVED)

    Note over Admin,DB: 5. 공개 설정 (구현 필요)
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: {status: 'opened'}
    API->>DB: UPDATE status = 'opened'
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (OPENED)

    Note over Admin,DB: 6. 공개 여부 활성화
    Admin->>API: PATCH /api/admin/news/:id/public
    Note right of API: {isPublic: true}
    API->>DB: UPDATE isPublic = true
    DB-->>API: 수정 완료
    API-->>Admin: 200 OK

    Note over Admin,DB: ✅ 사용자에게 노출됨
```

### 시나리오 2: 거부 후 재검토

```mermaid
sequenceDiagram
    participant Admin as 관리자
    participant API as API 서버
    participant DB as 데이터베이스

    Note over Admin,DB: 1-3. 생성 → 검토 요청 (생략)

    Note over Admin,DB: 4. 거부 (구현 필요)
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: {status: 'rejected'}
    API->>DB: UPDATE status = 'rejected'
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (REJECTED)

    Note over Admin,DB: 5. 수정 시작 (구현 필요)
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: {status: 'draft'}
    API->>DB: UPDATE status = 'draft'
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (DRAFT)

    Note over Admin,DB: 6. 내용 수정
    Admin->>API: PUT /api/admin/news/:id
    API->>DB: UPDATE title, description, url, files
    DB-->>API: 수정 완료
    API-->>Admin: 200 OK

    Note over Admin,DB: 7. 재검토 요청 (구현 필요)
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: {status: 'under_review'}
    API->>DB: UPDATE status = 'under_review'
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (UNDER_REVIEW)

    Note over Admin,DB: 8-10. 승인 → 공개 (생략)
```

### 시나리오 3: 공개된 콘텐츠 수정 (구현 필요)

```mermaid
sequenceDiagram
    participant Admin as 관리자
    participant API as API 서버
    participant DB as 데이터베이스
    participant User as 사용자

    Note over Admin,User: ✅ 현재 공개 중 (OPENED, isPublic: true)
    User->>API: GET /api/public/news
    API->>DB: SELECT WHERE status='opened' AND isPublic=true
    DB-->>API: 뉴스 목록
    API-->>User: 200 OK (노출됨)

    Note over Admin,User: 수정 필요 발생 (자동 상태 전이, 구현 필요)
    Admin->>API: PUT /api/admin/news/:id
    API->>DB: UPDATE status = 'draft' (자동 전이)
    API->>DB: UPDATE title, description, url, files
    DB-->>API: 수정 완료
    API-->>Admin: 200 OK (DRAFT)

    Note over Admin,User: ❌ 사용자에게 노출 중단
    User->>API: GET /api/public/news
    API->>DB: SELECT WHERE status='opened' AND isPublic=true
    DB-->>API: 해당 뉴스 제외
    API-->>User: 200 OK (노출 안 됨)

    Note over Admin,User: 수정 → 검토 → 승인 → 재공개
    Admin->>API: PATCH /api/admin/news/:id/status
    Note right of API: under_review → approved → opened
    API->>DB: UPDATE status
    DB-->>API: 상태 변경 완료
    API-->>Admin: 200 OK (OPENED)

    Note over Admin,User: ✅ 사용자에게 다시 노출됨
```

## 🎯 API 엔드포인트 상세 명세

### 1. 뉴스 생성 ✅

```
POST /api/admin/news
Content-Type: multipart/form-data

Body:
- title: string (필수, 제목)
- description: string (선택, 설명)
- url: string (선택, 외부 링크 또는 뉴스 기사 URL)
- files: 파일 배열 (PDF/JPG/PNG/WEBP)

Response: 201 Created
- status: 'draft' (기본값)
- isPublic: false (기본값)
```

### 2. 상태 변경 (구현 필요) ❌

```
PATCH /api/admin/news/:id/status

Body:
{
  "status": "under_review" | "approved" | "rejected" | "opened" | "draft"
}

Response: 200 OK
- 변경된 뉴스 정보
```

### 3. 공개 여부 변경 ✅

```
PATCH /api/admin/news/:id/public

Body:
{
  "isPublic": true | false
}

Response: 200 OK
- 변경된 뉴스 정보
```

### 4. 뉴스 수정 ✅

```
PUT /api/admin/news/:id
Content-Type: multipart/form-data

Body:
- title: string (필수, 제목)
- description: string (선택, 설명)
- url: string (선택, 외부 링크 또는 뉴스 기사 URL)
- files: 파일 배열 (전송한 파일들로 완전히 교체)

Response: 200 OK
- status가 'opened'였다면 자동으로 'draft'로 전이 (구현 필요)
```

### 5. 뉴스 삭제 (Soft Delete) ✅

```
DELETE /api/admin/news/:id

Response: 200 OK
{
  "success": true
}
```

### 6. 정렬 순서 일괄 수정 ✅

```
PUT /api/admin/news/batch-order

Body:
{
  "news": [
    { "id": "uuid1", "order": 1 },
    { "id": "uuid2", "order": 2 }
  ]
}

Response: 200 OK
{
  "success": true,
  "updatedCount": 2
}
```

### 7. 뉴스 목록 조회 (페이징) ✅

```
GET /api/admin/news?isPublic=true&orderBy=order&page=1&limit=10

Response: 200 OK
{
  "items": [...],
  "total": 50,
  "page": 1,
  "limit": 10,
  "totalPages": 5
}
```

### 8. 뉴스 전체 목록 조회 ✅

```
GET /api/admin/news/all

Response: 200 OK
[...뉴스 배열...]
```

### 9. 뉴스 상세 조회 ✅

```
GET /api/admin/news/:id

Response: 200 OK
{
  "id": "uuid",
  "title": "루미르, 신제품 출시",
  "description": "설명...",
  "url": "https://news.example.com/article",
  "status": "draft",
  "isPublic": false,
  "order": 0,
  "attachments": [...],
  ...
}
```

### 10. 카테고리 관련 API ✅

```
GET /api/admin/news/categories
POST /api/admin/news/categories
PATCH /api/admin/news/categories/:id
PATCH /api/admin/news/categories/:id/order
DELETE /api/admin/news/categories/:id
```

## 🔓 공개 조건 플로우

```mermaid
flowchart TD
    Start([뉴스 API 요청])
    Start --> CheckAPI{API 타입?}

    CheckAPI -->|관리자 API| AdminAPI[전체 조회 가능]
    CheckAPI -->|공개 API| PublicAPI[필터링 필요]

    PublicAPI --> CheckDeleted{deletedAt이 null인가?}

    CheckDeleted -->|No| NotVisible1[❌ 노출 안 됨]
    CheckDeleted -->|Yes| CheckStatus{status가 opened인가?}

    CheckStatus -->|No| NotVisible2[❌ 노출 안 됨]
    CheckStatus -->|Yes| CheckPublic{isPublic이 true인가?}

    CheckPublic -->|No| NotVisible3[❌ 노출 안 됨]
    CheckPublic -->|Yes| Visible[✅ 사용자에게 노출됨]

    style NotVisible1 fill:#ffcccc
    style NotVisible2 fill:#ffcccc
    style NotVisible3 fill:#ffcccc
    style Visible fill:#ccffcc
    style AdminAPI fill:#e3f2fd
```

## 📋 상태 전이 규칙 요약

### 허용되는 전이

| 현재 상태      | 다음 상태      | API 엔드포인트                        | 조건        | 구현 상태 |
| -------------- | -------------- | ------------------------------------- | ----------- | --------- |
| `draft`        | `under_review` | `PATCH /api/admin/news/:id/status`    | 검토 요청   | ❌        |
| `under_review` | `approved`     | `PATCH /api/admin/news/:id/status`    | 승인        | ❌        |
| `under_review` | `rejected`     | `PATCH /api/admin/news/:id/status`    | 거부        | ❌        |
| `under_review` | `draft`        | `PATCH /api/admin/news/:id/status`    | 검토 취소   | ❌        |
| `approved`     | `opened`       | `PATCH /api/admin/news/:id/status`    | 공개 설정   | ❌        |
| `approved`     | `draft`        | `PUT /api/admin/news/:id` (자동 전이) | 수정 시작   | ❌        |
| `rejected`     | `draft`        | `PATCH /api/admin/news/:id/status`    | 수정 시작   | ❌        |
| `opened`       | `draft`        | `PUT /api/admin/news/:id` (자동 전이) | 수정 시작   | ❌        |
| `opened`       | `opened`       | `PATCH /api/admin/news/:id/public`    | 비공개 설정 | ✅        |

### 금지되는 전이

- ❌ `draft` → `approved` (검토 없이 승인 불가)
- ❌ `draft` → `opened` (검토 및 승인 없이 공개 불가)
- ❌ `rejected` → `approved` (거부 후 바로 승인 불가)
- ❌ `rejected` → `opened` (거부된 콘텐츠 공개 불가)
- ❌ `under_review` → `opened` (검토 중 공개 불가)

## 🔧 구현 필요 사항

### 현재 구현된 기능 ✅

- ✅ 뉴스 생성 (기본값: `status: 'draft'`)
- ✅ 뉴스 목록 조회 (페이징)
- ✅ 뉴스 전체 목록 조회
- ✅ 뉴스 상세 조회
- ✅ 공개 여부 수정 (`isPublic`)
- ✅ 뉴스 수정 (내용 및 파일)
- ✅ 정렬 순서 일괄 수정
- ✅ 삭제 (Soft Delete)
- ✅ 카테고리 CRUD

### 구현 필요 기능 ❌

- ⚠️ **상태 변경 API** (`PATCH /api/admin/news/:id/status`)
  - 상태 전이 검증 로직
  - 허용되지 않는 상태 전이 방지
  - 상태별 액션 제한 검증

- ⚠️ **자동 상태 전이**
  - `opened` 또는 `approved` 상태에서 내용 수정 시 자동으로 `draft`로 전이
  - 트랜잭션 처리 필요

- ⚠️ **상태별 권한 체크**
  - 검토중 상태에서는 수정/삭제 불가
  - 승인 권한이 있는 사용자만 상태 변경 가능

## 📚 참고 사항

- 상태 변경은 **원자적(Atomic)**으로 처리되어야 함
- 상태 전이 시 **이력 로깅** 고려 (선택사항)
- **Optimistic Locking** (`version` 필드)을 활용하여 동시 수정 방지
- 상태별 **권한 체크** 필요 (예: 승인 권한이 있는 사용자만 상태 변경 가능)

## 🎨 다국어 전략

뉴스는 **다국어를 지원하지 않습니다**. 단일 언어(한국어)로만 작성되며, 제목(title), 설명(description), URL이 직접 엔티티에 저장됩니다.

## 🗂️ 파일 관리 전략

뉴스의 첨부파일은 다음과 같이 관리됩니다:

1. **파일 업로드**: AWS S3에 업로드되며 JSONB 형태로 저장
2. **파일 수정**: 기존 파일 전부 삭제 후 새 파일로 교체
3. **파일 형식**: PDF, JPG, PNG, WEBP 지원

## 📰 뉴스의 특징

뉴스는 언론 보도 및 뉴스 기사를 관리하는 콘텐츠로, 다음과 같은 특징이 있습니다:

| 특징                | 설명                                         |
| ------------------- | -------------------------------------------- |
| **대상**            | 일반 사용자 (언론 보도 확인)                 |
| **다국어 지원**     | ❌ 미지원 (단일 언어만 사용)                 |
| **외부 링크 (URL)** | ✅ 지원 (뉴스 기사 원본 링크 등)             |
| **파일 형식**       | PDF, 이미지 (보도 자료, 기사 캡처 등)        |
| **카테고리**        | ✅ 지원 (언론사별, 주제별 등)                |
| **정렬**            | order(정렬순서) 또는 createdAt(생성일시) 기준 |

## 🆚 루미르스토리와의 비교

| 특징                | 루미르스토리             | 뉴스                         |
| ------------------- | ------------------------ | ---------------------------- |
| 다국어 지원         | ❌ 미지원                | ❌ 미지원                    |
| 제목/내용 저장 위치 | 메인 엔티티              | 메인 엔티티                  |
| 외부 링크 (URL)     | ❌ 없음                  | ✅ 지원 (url 필드)           |
| 썸네일 이미지       | ✅ imageUrl 별도 관리    | ❌ 없음                      |
| 파일 형식           | PDF/이미지               | PDF/이미지                   |
| 대상                | 회사 스토리 및 콘텐츠    | 언론 보도 및 뉴스 기사       |
| CQRS 패턴           | ✅ 사용                  | ✅ 사용                      |

## 📄 뉴스 엔티티 구조

### 주요 필드

- **title**: 뉴스 제목 (필수, varchar 500)
- **description**: 뉴스 설명 (선택, text)
- **url**: 외부 링크 또는 뉴스 기사 URL (선택, text)
- **status**: 콘텐츠 상태 (enum)
- **isPublic**: 공개 여부 (boolean)
- **attachments**: 첨부파일 목록 (jsonb)
- **order**: 정렬 순서 (int)

### 뉴스만의 특징

- **외부 링크 지원**: `url` 필드를 통해 언론사 기사 원본 링크 연결
- **간결한 구조**: 다국어 지원 없이 단순하고 빠른 콘텐츠 관리
- **언론 보도 관리**: 회사 관련 언론 보도 및 기사 취합
