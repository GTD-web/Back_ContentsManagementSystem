# 백업 스크립트 사용 가이드

데이터베이스 백업을 명령줄에서 실행할 수 있는 스크립트 모음입니다.

## 📋 목차

1. [백업 실행](#백업-실행)
2. [백업 목록 조회](#백업-목록-조회)
3. [백업 정리](#백업-정리)
4. [문제 해결](#문제-해결)

---

## 백업 실행

### 모든 타입 백업 실행

모든 백업 타입(4시간/일/주/월/분기/년)을 순차적으로 실행합니다.

```bash
npm run backup
```

**출력 예시:**
```
🚀 백업 스크립트 시작

📦 모든 백업 타입을 실행합니다...

📦 four_hourly 백업 실행 중...
✅ four_hourly 백업 성공 - 2.5 MB

📦 daily 백업 실행 중...
✅ daily 백업 성공 - 2.5 MB

...

==================================================
📊 백업 결과 요약
==================================================
✅ 성공: 6/6
❌ 실패: 0/6

✅ 백업 스크립트 완료
```

### 특정 타입만 백업 실행

특정 백업 타입만 실행할 수 있습니다.

```bash
# 4시간 백업
npm run backup four_hourly

# 일간 백업
npm run backup daily

# 주간 백업
npm run backup weekly

# 월간 백업
npm run backup monthly

# 분기 백업
npm run backup quarterly

# 연간 백업
npm run backup yearly
```

**출력 예시:**
```
🚀 백업 스크립트 시작

📦 daily 백업을 실행합니다...

✅ daily 백업 성공
   파일명: backup_daily_20260121_153045.sql
   경로: ./backups/database/daily/backup_daily_20260121_153045.sql
   크기: 2.5 MB
   시간: 2026-01-21T15:30:45.123Z

✅ 백업 스크립트 완료
```

### 백업 타입 목록

| 타입 | 설명 | 보관 기간 | 목적 |
|------|------|----------|------|
| `four_hourly` | 4시간 백업 | 7일 | 최근 변경사항 빠른 복구 |
| `daily` | 일간 백업 | 30일 | 지난 한 달 내 복구 |
| `weekly` | 주간 백업 | 90일 (약 3개월) | 분기별 복구 포인트 |
| `monthly` | 월간 백업 | 365일 (1년) | 연간 복구 포인트 |
| `quarterly` | 분기 백업 | 730일 (2년) | 장기 보관 |
| `yearly` | 연간 백업 | 1825일 (5년) | 법적 요구사항 대응 |

---

## 백업 목록 조회

### 모든 백업 목록 조회

저장된 모든 백업 파일 목록을 조회합니다.

```bash
npm run backup:list
```

**출력 예시:**
```
📋 백업 목록 조회 스크립트 시작

📦 백업 목록 (총 15개)

================================================================================

📁 FOUR_HOURLY (6개)
--------------------------------------------------------------------------------
  1. backup_four_hourly_20260121_200000.sql
     생성: 2026. 1. 21. 오후 8:00:00
     만료: 2026. 1. 22. 오전 12:00:00

  2. backup_four_hourly_20260121_160000.sql
     생성: 2026. 1. 21. 오후 4:00:00
     만료: 2026. 1. 21. 오후 8:00:00 ⚠️ (만료됨)

...

📁 DAILY (7개)
--------------------------------------------------------------------------------
  1. backup_daily_20260121_010000.sql
     생성: 2026. 1. 21. 오전 1:00:00
     만료: 2026. 1. 22. 오전 1:00:00

...
```

### 특정 타입만 조회

```bash
# 일간 백업만 조회
npm run backup:list daily

# 월간 백업만 조회
npm run backup:list monthly
```

### 통계 포함 조회

백업 목록과 함께 통계 정보를 표시합니다.

```bash
npm run backup:list -- --stats
```

**출력 예시:**
```
...

================================================================================
📊 백업 통계

타입별 통계:
  four_hourly:
    개수: 6개
    크기: 15 MB
    가장 오래된 백업: 2026. 1. 21. 오전 0:00:00
  daily:
    개수: 7개
    크기: 17.5 MB
    가장 오래된 백업: 2026. 1. 15. 오전 1:00:00
  ...

전체:
  개수: 30개
  크기: 75 MB
```

---

## 백업 정리

만료된 백업 파일을 삭제합니다.

```bash
npm run backup:cleanup
```

**출력 예시:**
```
🧹 만료된 백업 정리 스크립트 시작

📋 만료된 백업을 확인하고 있습니다...

==================================================
📊 정리 결과
==================================================
📦 전체 백업: 30개
🗑️  삭제된 백업: 8개
❌ 오류: 0개

✅ 만료된 백업이 성공적으로 정리되었습니다.
```

### 정리 시나리오

백업은 각 타입별 보관 기간에 따라 자동으로 정리됩니다:

- **4시간 백업**: 7일이 지나면 삭제
- **일간 백업**: 30일이 지나면 삭제
- **주간 백업**: 90일(약 3개월)이 지나면 삭제
- **월간 백업**: 365일(1년)이 지나면 삭제
- **분기 백업**: 730일(2년)이 지나면 삭제
- **연간 백업**: 1825일(5년)이 지나면 삭제

> **참고**: 정리는 매일 새벽 5시에 자동으로 실행되지만, 이 스크립트로 수동 실행도 가능합니다.

---

## 문제 해결

### 1. "BACKUP_ENABLED=false" 오류

**증상:**
```
백업이 비활성화되어 있습니다.
```

**해결 방법:**

`.env` 파일에서 백업을 활성화하세요:

```bash
BACKUP_ENABLED=true
```

### 2. 백업 디렉토리 권한 오류

**증상:**
```
EACCES: permission denied, mkdir './backups/database'
```

**해결 방법:**

백업 디렉토리에 쓰기 권한을 부여하세요:

```bash
# Linux/Mac
mkdir -p ./backups/database
chmod 755 ./backups/database

# Windows
# 탐색기에서 backups 폴더 > 속성 > 보안 탭에서 권한 확인
```

### 4. 데이터베이스 연결 실패

**증상:**
```
connection refused
```

**해결 방법:**

1. 데이터베이스가 실행 중인지 확인:
   ```bash
   # Docker PostgreSQL 확인
   docker compose ps
   
   # PostgreSQL 프로세스 확인
   pg_isready -h localhost -p 5432
   ```

2. `.env` 파일의 데이터베이스 설정 확인:
   ```bash
   DATABASE_HOST=localhost
   DATABASE_PORT=5432
   DATABASE_USERNAME=postgres
   DATABASE_PASSWORD=your_password
   DATABASE_NAME=lumir_cms
   ```

### 5. 백업 파일 확인

SQL 파일이므로 텍스트 편집기로 열어서 내용을 확인할 수 있습니다:

```bash
# 파일 내용 미리보기
head -n 50 ./backups/database/daily/backup_daily_20260121_010000.sql

# 파일 크기 확인
ls -lh ./backups/database/daily/
```

### 6. 대용량 데이터베이스 백업 느림

**증상:**
대용량 데이터베이스 백업 시 시간이 오래 걸립니다.

**해결 방법:**

이는 정상입니다. TypeORM 방식은 pg_dump보다 약 20-25% 느립니다:

| 크기 | 예상 시간 |
|------|----------|
| 100MB | ~6초 |
| 1GB | ~60초 |
| 10GB | ~10분 |

**최적화 팁**:
- 백업을 트래픽이 적은 시간(새벽)에 실행
- 불필요한 로그 테이블 제외 고려
- 정기적인 데이터 정리

### 5. TypeScript 컴파일 오류

**증상:**
```
TSError: Cannot find module ...
```

**해결 방법:**

의존성을 다시 설치하세요:

```bash
npm install
```

---

## 추가 옵션

### cron에 등록하여 자동 실행

Linux/Mac 환경에서 cron에 등록하여 정기적으로 백업을 실행할 수 있습니다:

```bash
# crontab 편집
crontab -e

# 매일 새벽 1시에 일간 백업 실행
0 1 * * * cd /path/to/lumir-cms-backend && npm run backup daily >> /var/log/backup.log 2>&1

# 매주 일요일 새벽 2시에 주간 백업 실행
0 2 * * 0 cd /path/to/lumir-cms-backend && npm run backup weekly >> /var/log/backup.log 2>&1
```

### Windows 작업 스케줄러 등록

Windows에서는 작업 스케줄러를 사용할 수 있습니다:

1. **작업 스케줄러** 실행
2. **작업 만들기** 선택
3. **트리거** 탭에서 실행 시간 설정
4. **동작** 탭에서:
   - 프로그램: `C:\Program Files\nodejs\npm.cmd`
   - 인수: `run backup daily`
   - 시작 위치: `C:\Users\USER\dev\lumir-cms-backend`

---

## 스크립트 파일

- `run-backup.ts` - 백업 실행
- `cleanup-backups.ts` - 만료된 백업 정리
- `list-backups.ts` - 백업 목록 조회

모든 스크립트는 TypeScript로 작성되어 있으며, `ts-node`를 통해 실행됩니다.

---

## 참고 문서

- [데이터베이스 백업 가이드](../../docs/backup/database-backup-guide.md) - 전체 백업 시스템 가이드
- [환경변수 설정](../../docs/backup/environment-variables.md) - 백업 설정 가이드
- [백업 디렉토리 구조](../../backups/README.md) - 백업 저장 구조

---

**마지막 업데이트**: 2026-01-21  
**버전**: 1.0.0
